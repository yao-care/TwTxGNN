name: IndexNow - 通知搜尋引擎更新

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**/*.md'
      - 'docs/_drugs/**'
      - 'docs/_posts/**'

jobs:
  indexnow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed
        run: |
          # 取得變更的 markdown 檔案
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'docs/**/*.md' 'docs/_drugs/**' 'docs/_posts/**' | head -100)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No markdown files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "has_changes=true" >> $GITHUB_OUTPUT

          # 轉換為 URL 列表
          URLS=""
          for file in $CHANGED_FILES; do
            # 移除 docs/ 前綴和 .md 後綴
            url_path=$(echo "$file" | sed 's|^docs/||' | sed 's|\.md$|/|' | sed 's|^_drugs/|drugs/|' | sed 's|^_posts/[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-|blog/|')

            # index.md 特殊處理
            if [ "$url_path" = "index/" ]; then
              url_path=""
            fi

            full_url="https://twtxgnn.yao.care/${url_path}"
            URLS="${URLS}\"${full_url}\","
          done

          # 移除最後的逗號
          URLS=$(echo "$URLS" | sed 's/,$//')
          echo "urls=[$URLS]" >> $GITHUB_OUTPUT

      - name: Submit to IndexNow
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          # 準備 JSON payload
          PAYLOAD=$(cat <<EOF
          {
            "host": "twtxgnn.yao.care",
            "key": "8bc3f8b66efd47ccc1e1feb53e109ea6",
            "keyLocation": "https://twtxgnn.yao.care/8bc3f8b66efd47ccc1e1feb53e109ea6.txt",
            "urlList": ${{ steps.changed.outputs.urls }}
          }
          EOF
          )

          echo "Submitting to IndexNow:"
          echo "$PAYLOAD" | jq .

          # 提交到 Bing IndexNow
          curl -X POST "https://api.indexnow.org/indexnow" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            -w "\nHTTP Status: %{http_code}\n"
